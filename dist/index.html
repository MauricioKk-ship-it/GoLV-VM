<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoLV Dashboard - Terminal Sécurisé pour IA</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS Framework -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Toastify Notifications -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <!-- JSON Viewer -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/json-viewer/1.4.0/json-viewer.min.css">
    
    <style>
        /* Gardez TOUT le CSS existant, il est bon */
        :root {
            --primary: #6d28d9;
            --primary-dark: #5b21b6;
            --secondary: #0ea5e9;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --terminal-bg: #0f172a;
            --terminal-text: #e2e8f0;
            --terminal-green: #10b981;
            --terminal-yellow: #fbbf24;
            --terminal-red: #ef4444;
            --terminal-blue: #3b82f6;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        
        [data-theme="dark"] {
            --light: #1e293b;
            --dark: #f8fafc;
            --card-bg: rgba(30, 41, 59, 0.95);
            --terminal-bg: #0f172a;
            --terminal-text: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: var(--dark);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        /* Gardez TOUT le reste du CSS existant */
        /* ... */
        
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="color: white; font-size: 1.2rem;">Connexion à GoLV API...</div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container-fluid">
            <div class="logo">
                <i class="fas fa-server logo-icon"></i>
                <span>GoLV Dashboard</span>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="badge-container" id="serverStatusBadges">
                    <span class="custom-badge" style="background: #6d28d9; color: white;">
                        <i class="fas fa-server"></i> <span id="totalVMs">0</span> VMs
                    </span>
                    <span class="custom-badge" style="background: #10b981; color: white;">
                        <i class="fas fa-play"></i> <span id="runningVMs">0</span> Running
                    </span>
                    <span class="custom-badge" style="background: #3b82f6; color: white;">
                        <i class="fas fa-bolt"></i> <span id="apiStatus">Checking...</span>
                    </span>
                </div>
                
                <button class="btn btn-golv" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                
                <div class="dropdown">
                    <button class="btn btn-golv dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> <span id="usernameDisplay">Non connecté</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="showLoginModal()"><i class="fas fa-sign-in-alt"></i> Connexion</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showRegisterModal()"><i class="fas fa-user-plus"></i> Inscription</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Gardez TOUTE la structure HTML existante -->
    <!-- ... (Tout le HTML reste identique) ... -->

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json-viewer/1.4.0/json-viewer.min.js"></script>
    
    <script>
        // ============================================
        // CONFIGURATION CORRIGÉE POUR VOTRE SERVEUR
        // ============================================
        const API_BASE_URL = 'https://golv.onrender.com';  // Votre serveur
        let currentToken = localStorage.getItem('golv_token') || '';
        let currentUser = localStorage.getItem('golv_user') || '';
        let currentUserId = localStorage.getItem('golv_user_id') || '';
        let currentVM = localStorage.getItem('golv_vm') || '';
        let apiCalls = 0;
        let commandHistory = [];
        let userVMs = [];

        // ============================================
        // FONCTIONS UTILITAIRES AMÉLIORÉES
        // ============================================
        
        async function makeApiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            
            if (currentToken) {
                defaultHeaders['Authorization'] = `Bearer ${currentToken}`;
            }
            
            console.log(`API Request: ${options.method || 'GET'} ${url}`);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...defaultHeaders,
                        ...options.headers
                    },
                    mode: 'cors'
                });
                
                apiCalls++;
                updateStats();
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                return data;
                
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            }
        }

        function showToast(title, message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            Toastify({
                text: `<strong>${title}</strong><br>${message}`,
                duration: 3000,
                close: true,
                gravity: 'top',
                position: 'right',
                backgroundColor: colors[type],
                escapeMarkup: false
            }).showToast();
        }

        function showLoading(message = 'Chargement...') {
            const overlay = document.getElementById('loadingOverlay');
            overlay.querySelector('div:nth-child(2)').textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 500);
        }

        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            init();
        });

        async function init() {
            console.log('Initialisation GoLV Dashboard...');
            
            // Vérifier la connexion API
            await checkApiStatus();
            
            // Vérifier si l'utilisateur est connecté
            if (currentToken && currentUser) {
                try {
                    // Vérifier si le token est toujours valide
                    const userInfo = await makeApiRequest('/api/auth/me');
                    
                    showToast('Connexion automatique', `Bonjour ${currentUser}!`, 'success');
                    loadDashboard();
                    
                } catch (error) {
                    console.log('Token invalide, déconnexion...');
                    logout();
                }
            } else {
                showAuthSection();
            }
            
            // Cacher le loading
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 1000);
        }

        // ============================================
        // AUTHENTIFICATION - CORRIGÉ
        // ============================================
        async function login(event) {
            if (event) event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showToast('Erreur', 'Veuillez remplir tous les champs', 'error');
                return;
            }
            
            showLoading('Connexion en cours...');
            
            try {
                // ENDPOINT CORRECT selon votre serveur
                const response = await makeApiRequest('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                // FORMAT DE RÉPONSE de votre serveur
                if (response.access_token) {
                    currentToken = response.access_token;
                    currentUser = response.username;
                    currentUserId = response.user_id;
                    
                    // Sauvegarder dans localStorage
                    localStorage.setItem('golv_token', currentToken);
                    localStorage.setItem('golv_user', currentUser);
                    localStorage.setItem('golv_user_id', currentUserId);
                    
                    hideModal('loginModal');
                    showToast('Connexion réussie', `Bienvenue ${currentUser}!`, 'success');
                    loadDashboard();
                    
                } else {
                    showToast('Erreur', 'Format de réponse incorrect', 'error');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('Erreur de connexion', error.message || 'Identifiants incorrects', 'error');
            }
            
            hideLoading();
        }

        async function register(event) {
            if (event) event.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            if (!username || !password) {
                showToast('Erreur', 'Veuillez remplir tous les champs', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showToast('Erreur', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Erreur', 'Le mot de passe doit faire au moins 6 caractères', 'error');
                return;
            }
            
            showLoading('Création du compte...');
            
            try {
                // ENDPOINT CORRECT selon votre serveur
                const response = await makeApiRequest('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                if (response.access_token) {
                    currentToken = response.access_token;
                    currentUser = response.username;
                    currentUserId = response.user_id;
                    
                    // Sauvegarder dans localStorage
                    localStorage.setItem('golv_token', currentToken);
                    localStorage.setItem('golv_user', currentUser);
                    localStorage.setItem('golv_user_id', currentUserId);
                    
                    hideModal('registerModal');
                    showToast('Compte créé', `Bienvenue ${currentUser}!`, 'success');
                    loadDashboard();
                    
                } else {
                    showToast('Erreur', 'Format de réponse incorrect', 'error');
                }
                
            } catch (error) {
                console.error('Register error:', error);
                showToast('Erreur d\'inscription', error.message || 'Nom d\'utilisateur déjà pris', 'error');
            }
            
            hideLoading();
        }

        // ============================================
        // GESTION DES VMs - CORRIGÉ
        // ============================================
        async function loadVMs() {
            if (!currentToken) {
                console.log('Non connecté, impossible de charger les VMs');
                return;
            }
            
            showLoading('Chargement des VMs...');
            
            try {
                // ENDPOINT CORRECT
                const response = await makeApiRequest('/api/vms?public_only=false');
                
                if (response.success && response.data) {
                    userVMs = response.data;
                    
                    updateVMsDisplay();
                    updateVMSelect();
                    
                    // Mettre à jour les stats
                    const totalVMs = userVMs.length;
                    const runningVMs = userVMs.filter(vm => 
                        vm.status === 'running' || vm.status === 'active'
                    ).length;
                    
                    document.getElementById('totalVMs').textContent = totalVMs;
                    document.getElementById('totalVMsStat').textContent = totalVMs;
                    document.getElementById('runningVMs').textContent = runningVMs;
                    document.getElementById('runningVMsStat').textContent = runningVMs;
                    
                    // Sélectionner la première VM si aucune n'est sélectionnée
                    if (!currentVM && userVMs.length > 0) {
                        currentVM = userVMs[0].id;
                        localStorage.setItem('golv_vm', currentVM);
                        updateTerminalPrompt();
                    }
                    
                } else {
                    console.log('Aucune VM trouvée ou format de réponse incorrect');
                    userVMs = [];
                    updateVMsDisplay();
                }
                
            } catch (error) {
                console.error('Error loading VMs:', error);
                showToast('Erreur', 'Impossible de charger les VMs', 'error');
                userVMs = [];
                updateVMsDisplay();
            }
            
            hideLoading();
        }

        async function createVM(event) {
            if (event) event.preventDefault();
            
            const name = document.getElementById('vmName').value;
            const type = document.getElementById('vmType').value;
            const version = document.getElementById('vmVersion').value;
            const isPublic = document.getElementById('vmPublic').checked;
            
            if (!name || !type || !version) {
                showToast('Erreur', 'Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            showLoading('Création de la VM...');
            
            try {
                // FORMAT CORRECT pour votre API
                const response = await makeApiRequest('/api/vms', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: name,
                        vm_type: type,
                        version: version,
                        is_public: isPublic,
                        tags: ['web-created']
                    })
                });
                
                if (response.success) {
                    hideModal('createVMModal');
                    showToast('VM créée', `VM ${response.vm_id} créée avec succès!`, 'success');
                    
                    // Réinitialiser le formulaire
                    document.getElementById('createVMForm').reset();
                    
                    // Recharger les VMs
                    await loadVMs();
                    
                } else {
                    showToast('Erreur', response.message || 'Erreur de création', 'error');
                }
                
            } catch (error) {
                console.error('Create VM error:', error);
                showToast('Erreur', error.message || 'Impossible de créer la VM', 'error');
            }
            
            hideLoading();
        }

        // ============================================
        // EXÉCUTION DE COMMANDES - CORRIGÉ
        // ============================================
        async function executeCommand() {
            const command = document.getElementById('terminalInput').value.trim();
            if (!command) {
                showToast('Erreur', 'Veuillez entrer une commande', 'error');
                return;
            }
            
            if (!currentVM) {
                showToast('Erreur', 'Veuillez sélectionner une VM', 'error');
                return;
            }
            
            // Ajouter la commande au terminal
            addTerminalOutput(`$ ${command}`, 'command');
            
            // Effacer l'entrée
            document.getElementById('terminalInput').value = '';
            
            showLoading('Exécution de la commande...');
            
            try {
                // ENDPOINT CORRECT selon votre serveur
                const response = await makeApiRequest(`/api/vms/${currentVM}/execute`, {
                    method: 'POST',
                    body: JSON.stringify({
                        command: command,
                        timeout: 30,
                        user: "root",
                        async_execution: false
                    })
                });
                
                if (response.success) {
                    const result = response.data;
                    
                    // Ajouter à l'historique
                    commandHistory.push({
                        command: command,
                        result: result,
                        timestamp: new Date().toISOString()
                    });
                    
                    updateCommandHistory();
                    
                    // Afficher le résultat dans le terminal
                    if (result.success) {
                        if (result.stdout) {
                            addTerminalOutput(result.stdout, 'success');
                        }
                    } else {
                        if (result.error) {
                            addTerminalOutput(`Erreur: ${result.error}`, 'error');
                        }
                        if (result.stderr) {
                            addTerminalOutput(result.stderr, 'error');
                        }
                    }
                    
                    // Mettre à jour les stats
                    document.getElementById('commandsExecuted').textContent = 
                        parseInt(document.getElementById('commandsExecuted').textContent) + 1;
                    
                } else {
                    addTerminalOutput(`Erreur: ${response.message || 'Erreur inconnue'}`, 'error');
                }
                
            } catch (error) {
                console.error('Execute command error:', error);
                addTerminalOutput(`Erreur réseau: ${error.message}`, 'error');
            }
            
            hideLoading();
        }

        async function runPredefinedCommand(commandType) {
            if (!currentVM) {
                showToast('Erreur', 'Veuillez sélectionner une VM', 'error');
                return;
            }
            
            addTerminalOutput(`$ [PREDEFINED] ${commandType}`, 'command');
            
            showLoading('Exécution de la commande...');
            
            try {
                // ENDPOINT CORRECT
                const response = await makeApiRequest(`/api/vms/${currentVM}/execute/predefined`, {
                    method: 'POST',
                    body: JSON.stringify(commandType)
                });
                
                if (response.success) {
                    const result = response.data;
                    
                    // Ajouter à l'historique
                    commandHistory.push({
                        command: `[PREDEFINED] ${commandType}`,
                        result: result,
                        timestamp: new Date().toISOString()
                    });
                    
                    updateCommandHistory();
                    
                    if (result.success && result.stdout) {
                        addTerminalOutput(result.stdout, 'success');
                    }
                    
                } else {
                    addTerminalOutput(`Erreur: ${response.message || 'Erreur inconnue'}`, 'error');
                }
                
            } catch (error) {
                console.error('Predefined command error:', error);
                addTerminalOutput(`Erreur: ${error.message}`, 'error');
            }
            
            hideLoading();
        }

        // ============================================
        // GESTION DE L'INTERFACE - CORRIGÉ
        // ============================================
        function updateVMsDisplay() {
            const container = document.getElementById('vmListContainer');
            
            if (!userVMs || userVMs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-server fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Aucune VM trouvée</p>
                        <button class="btn btn-golv btn-sm" onclick="showCreateVMModal()">
                            <i class="fas fa-plus"></i> Créer une VM
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            userVMs.forEach(vm => {
                const isActive = vm.id === currentVM;
                const statusClass = vm.status === 'running' ? 'vm-status-running' : 'vm-status-stopped';
                
                html += `
                    <div class="vm-item ${isActive ? 'active' : ''}" 
                         onclick="selectVM('${vm.id}')">
                        <div>
                            <span class="vm-status ${statusClass}"></span>
                            <strong>${vm.name || vm.id}</strong>
                            <small class="text-muted d-block">${vm.vm_type || 'unknown'} ${vm.version || ''}</small>
                        </div>
                        <div>
                            <span class="badge ${vm.is_public ? 'bg-info' : 'bg-secondary'}">
                                ${vm.is_public ? 'Public' : 'Privé'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateVMSelect() {
            const select = document.getElementById('vmSelect');
            select.innerHTML = '<option value="">Sélectionnez une VM</option>';
            
            userVMs.forEach(vm => {
                const option = document.createElement('option');
                option.value = vm.id;
                option.textContent = `${vm.name || vm.id} (${vm.vm_type || 'unknown'})`;
                if (vm.id === currentVM) option.selected = true;
                select.appendChild(option);
            });
            
            select.onchange = function() {
                selectVM(this.value);
            };
        }

        function selectVM(vmId) {
            currentVM = vmId;
            localStorage.setItem('golv_vm', vmId);
            
            updateTerminalPrompt();
            updateVMsDisplay();
            
            // Mettre à jour la sélection
            document.getElementById('vmSelect').value = vmId;
            
            showToast('VM sélectionnée', 'Terminal prêt pour cette VM', 'success');
            
            // Charger l'historique des commandes de cette VM
            loadVMCommands(vmId);
        }

        async function loadVMCommands(vmId) {
            try {
                const response = await makeApiRequest(`/api/vms/${vmId}/commands?limit=10`);
                
                if (response.success && response.database_history) {
                    // Fusionner l'historique
                    const dbHistory = response.database_history.map(cmd => ({
                        command: cmd.command,
                        result: {
                            success: cmd.status === 'completed',
                            stdout: cmd.stdout,
                            stderr: cmd.stderr,
                            return_code: cmd.return_code
                        },
                        timestamp: cmd.executed_at
                    }));
                    
                    commandHistory = [...dbHistory, ...commandHistory.filter(cmd => 
                        !dbHistory.some(dbCmd => dbCmd.timestamp === cmd.timestamp)
                    )];
                    
                    updateCommandHistory();
                }
            } catch (error) {
                console.log('Impossible de charger l\'historique des commandes:', error);
            }
        }

        function updateTerminalPrompt() {
            const vm = userVMs.find(v => v.id === currentVM);
            const prompt = vm ? `golv:${vm.name || vm.id}$` : '$';
            document.getElementById('terminalPrompt').textContent = prompt;
        }

        function addTerminalOutput(text, type = 'normal') {
            const terminal = document.getElementById('terminalOutput');
            const line = document.createElement('div');
            line.className = 'terminal-line';
            
            if (type === 'command') {
                line.innerHTML = `<span class="terminal-command">${text}</span>`;
            } else if (type === 'error') {
                line.innerHTML = `<span class="terminal-error">${text}</span>`;
            } else if (type === 'success') {
                line.innerHTML = `<span class="terminal-success">${text}</span>`;
            } else if (type === 'warning') {
                line.innerHTML = `<span class="terminal-warning">${text}</span>`;
            } else {
                line.textContent = text;
            }
            
            terminal.appendChild(line);
            
            // Auto-scroll
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateCommandHistory() {
            const container = document.getElementById('commandHistory');
            
            if (!commandHistory || commandHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-history"></i> Aucune commande exécutée
                    </div>
                `;
                return;
            }
            
            let html = '';
            commandHistory.slice(-10).reverse().forEach((item, index) => {
                const time = new Date(item.timestamp).toLocaleTimeString();
                const success = item.result?.success;
                
                html += `
                    <div class="vm-item">
                        <div>
                            <code style="font-size: 0.9rem;">${item.command.length > 50 ? item.command.substring(0, 50) + '...' : item.command}</code>
                            <small class="text-muted d-block">${time}</small>
                        </div>
                        <div>
                            <span class="badge ${success ? 'bg-success' : 'bg-danger'}">
                                ${success ? '✓' : '✗'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // GESTION DU DASHBOARD
        // ============================================
        function showAuthSection() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('usernameDisplay').textContent = 'Non connecté';
        }

        async function loadDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'grid';
            document.getElementById('usernameDisplay').textContent = currentUser;
            document.getElementById('userInfo').textContent = currentUser;
            
            // Charger les données utilisateur
            await loadVMs();
            updateCommandHistory();
            updateStats();
            updateTerminalPrompt();
            
            // Mettre à jour l'URL du serveur
            document.getElementById('serverUrl').textContent = API_BASE_URL;
            document.getElementById('apiUrlDisplay').textContent = API_BASE_URL;
        }

        function logout() {
            currentToken = '';
            currentUser = '';
            currentUserId = '';
            currentVM = '';
            
            localStorage.removeItem('golv_token');
            localStorage.removeItem('golv_user');
            localStorage.removeItem('golv_user_id');
            localStorage.removeItem('golv_vm');
            
            commandHistory = [];
            userVMs = [];
            
            showToast('Déconnexion', 'Vous avez été déconnecté', 'info');
            showAuthSection();
        }

        // ============================================
        // STATUT API ET CONNEXION
        // ============================================
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.status === 200 || response.status === 404) {
                    // Le serveur répond
                    const data = await response.json();
                    
                    document.getElementById('apiStatus').textContent = 'Online';
                    document.getElementById('apiStatusBadge').textContent = 'Online';
                    document.getElementById('apiStatusBadge').className = 'badge bg-success';
                    
                    console.log('API Status:', data);
                    return true;
                    
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('API check error:', error);
                
                document.getElementById('apiStatus').textContent = 'Offline';
                document.getElementById('apiStatusBadge').textContent = 'Offline';
                document.getElementById('apiStatusBadge').className = 'badge bg-danger';
                
                showToast('Serveur hors ligne', 'Impossible de se connecter au serveur GoLV', 'error');
                return false;
            }
        }

        function updateStats() {
            document.getElementById('apiCalls').textContent = apiCalls;
            document.getElementById('commandsExecuted').textContent = commandHistory.length;
        }

        function refreshStats() {
            loadVMs();
            showToast('Rafraîchissement', 'Statistiques mises à jour', 'info');
        }

        function testConnection() {
            showLoading('Test de connexion...');
            
            setTimeout(async () => {
                const isOnline = await checkApiStatus();
                
                if (isOnline) {
                    showToast('Connexion OK', 'Serveur GoLV accessible', 'success');
                } else {
                    showToast('Connexion échouée', 'Serveur GoLV inaccessible', 'error');
                }
                
                hideLoading();
            }, 1000);
        }

        // ============================================
        // GESTION DES ÉVÉNEMENTS
        // ============================================
        function handleTerminalKeyPress(event) {
            if (event.key === 'Enter') {
                executeCommand();
            }
        }

        // ============================================
        // FONCTIONS MODALES (inchangées)
        // ============================================
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('active');
        }

        function showCreateVMModal() {
            document.getElementById('createVMModal').classList.add('active');
        }

        function showGenerateApiKeyModal() {
            document.getElementById('generateApiKeyModal').classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function toggleTheme() {
            const theme = document.body.getAttribute('data-theme');
            const icon = document.getElementById('themeIcon');
            
            if (theme === 'dark') {
                document.body.removeAttribute('data-theme');
                icon.className = 'fas fa-moon';
                localStorage.setItem('golv_theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
                localStorage.setItem('golv_theme', 'dark');
            }
        }

        function switchTerminalTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // TODO: Implémenter le changement d'onglet si nécessaire
        }

        function showApiDocs() {
            window.open(`${API_BASE_URL}/docs`, '_blank');
        }

        // ============================================
        // INITIALISATION DU THÈME
        // ============================================
        const savedTheme = localStorage.getItem('golv_theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').className = 'fas fa-sun';
        }

        // ============================================
        // FONCTIONS POUR LE MODE DÉMO (en cas d'API hors ligne)
        // ============================================
        function enableDemoMode() {
            console.log('Activation du mode démo...');
            
            // Données de démo
            userVMs = [
                { 
                    id: 'demo-1', 
                    name: 'VM Python Demo', 
                    vm_type: 'python-dev', 
                    version: '3.11', 
                    status: 'running', 
                    is_public: true 
                },
                { 
                    id: 'demo-2', 
                    name: 'Serveur Ubuntu', 
                    vm_type: 'ubuntu', 
                    version: '22.04 LTS', 
                    status: 'stopped', 
                    is_public: false 
                }
            ];
            
            // Simuler une connexion
            currentUser = 'demo_user';
            currentUserId = 'demo_123';
            
            // Mettre à jour l'affichage
            updateVMsDisplay();
            updateStats();
            
            showToast('Mode démo', 'API hors ligne - Mode démo activé', 'warning');
        }

        // Vérifier si on doit activer le mode démo
        setTimeout(async () => {
            const isOnline = await checkApiStatus();
            if (!isOnline && !currentToken) {
                enableDemoMode();
            }
        }, 2000);

    </script>
</body>
</html>
